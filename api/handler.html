<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Thai Law Data API</title>
</head>
<body>
    <script>
        // API Handler for Thai Law Data
        // Supports URL parameters: code, filter, search, sort, order, limit, offset
        
        (async function() {
            try {
                const params = new URLSearchParams(window.location.search);
                
                // Get parameters
                const codeType = params.get('code') || 'civil_and_commercial_code';
                const filterId = params.get('filter_id');
                const filterTitle = params.get('filter_title');
                const filterContent = params.get('filter_content');
                const searchQuery = params.get('search');
                const sortBy = params.get('sort') || 'id';
                const sortOrder = params.get('order') || 'asc';
                const limit = params.get('limit') ? parseInt(params.get('limit')) : null;
                const offset = params.get('offset') ? parseInt(params.get('offset')) : 0;
                
                // Fetch the data
                const response = await fetch(`${codeType}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                let items = data[codeType];
                
                if (!items) {
                    throw new Error(`Invalid code type: ${codeType}`);
                }
                
                // Apply filters
                if (filterId) {
                    items = items.filter(item => item.id == filterId);
                }
                if (filterTitle) {
                    const titleLower = filterTitle.toLowerCase();
                    items = items.filter(item => 
                        item.title && item.title.toLowerCase().includes(titleLower)
                    );
                }
                if (filterContent) {
                    const contentLower = filterContent.toLowerCase();
                    items = items.filter(item => 
                        item.content && item.content.toLowerCase().includes(contentLower)
                    );
                }
                
                // Apply search (searches across all text fields)
                if (searchQuery) {
                    const searchLower = searchQuery.toLowerCase();
                    items = items.filter(item => {
                        const titleMatch = item.title && item.title.toLowerCase().includes(searchLower);
                        const contentMatch = item.content && item.content.toLowerCase().includes(searchLower);
                        const idMatch = item.id && item.id.toString().includes(searchLower);
                        return titleMatch || contentMatch || idMatch;
                    });
                }
                
                // Apply sorting
                if (sortBy && items.length > 0) {
                    items.sort((a, b) => {
                        let aVal = a[sortBy];
                        let bVal = b[sortBy];
                        
                        // Handle undefined values
                        if (aVal === undefined) return 1;
                        if (bVal === undefined) return -1;
                        
                        // Compare based on type
                        if (typeof aVal === 'number' && typeof bVal === 'number') {
                            return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                        } else {
                            // Convert to string for comparison
                            aVal = String(aVal).toLowerCase();
                            bVal = String(bVal).toLowerCase();
                            
                            if (sortOrder === 'asc') {
                                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                            } else {
                                return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                            }
                        }
                    });
                }
                
                // Apply pagination
                const total = items.length;
                if (limit !== null) {
                    items = items.slice(offset, offset + limit);
                }
                
                // Build response
                const result = {
                    code: codeType,
                    total: total,
                    offset: offset,
                    limit: limit,
                    count: items.length,
                    data: items
                };
                
                // Output as JSON
                const preElement = document.createElement('pre');
                preElement.textContent = JSON.stringify(result, null, 2);
                document.body.innerHTML = '';
                document.body.appendChild(preElement);
                document.contentType = 'application/json';
                
            } catch (error) {
                const errorResponse = {
                    error: error.message,
                    code: params.get('code') || 'civil_and_commercial_code'
                };
                const preElement = document.createElement('pre');
                preElement.textContent = JSON.stringify(errorResponse, null, 2);
                document.body.innerHTML = '';
                document.body.appendChild(preElement);
            }
        })();
    </script>
</body>
</html>
